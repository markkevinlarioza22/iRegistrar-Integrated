<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard - iRegistrar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/style.css" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #f3f7fc; display: flex; }
    .sidebar { width: 230px; background: #003b8b; color: white; height: 100vh; padding: 20px 0; position: fixed; }
    .sidebar h2 { text-align: center; margin-bottom: 30px; font-size: 22px; }
    .sidebar a { display: block; padding: 12px 20px; color: white; text-decoration: none; font-size: 15px; }
    .sidebar a:hover, .sidebar a.active { background: #0050b5; }
    .main { margin-left: 230px; padding: 20px; width: calc(100% - 230px); }
    h1 { margin-top: 0; }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 6px; overflow: hidden; }
    th, td { padding: 12px; border-bottom: 1px solid #ddd; font-size: 15px; }
    th { background: #0050b5; color: white; }
    select { padding: 6px; }
    .return-btn { background: #003b8b; color: white; padding: 8px 14px; border: none; cursor: pointer; border-radius: 4px; margin-bottom: 15px; }
    .return-btn:hover { background: #0050b5; }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <h2>Admin Panel</h2>
    <a href="#" class="active" onclick="showSection('requests')">üìÑ Requests</a>
    <a href="#" onclick="showSection('users')">üë• Users</a>
    <a href="#" onclick="showSection('analytics')">üìä Analytics</a>
    <a href="#" onclick="showSection('settings')">‚öôÔ∏è Settings</a>
    <hr style="border:1px solid #1a58ad;">
    <a href="#" id="logoutBtn">üö™ Logout</a>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main">

    <!-- REQUESTS SECTION -->
    <div id="requests" class="section">
      <button class="return-btn" onclick="history.back()">‚¨Ö Return</button>
      <h1>Document Requests</h1>
      <table id="requestTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Document</th>
            <th>Purpose</th>
            <th>Status</th>
            <th>Date</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody><tr><td colspan="7">Loading...</td></tr></tbody>
      </table>
    </div>

    <!-- USERS SECTION -->
    <div id="users" class="section" style="display:none;">
      <button class="return-btn" onclick="history.back()">‚¨Ö Return</button>
      <h1>Users</h1>
      <p>Users module coming soon...</p>
    </div>

    <!-- ANALYTICS -->
    <div id="analytics" class="section" style="display:none;">
      <button class="return-btn" onclick="history.back()">‚¨Ö Return</button>
      <h1>Analytics</h1>
      <p>Analytics charts will be added later...</p>
    </div>

    <!-- SETTINGS -->
    <div id="settings" class="section" style="display:none;">
      <button class="return-btn" onclick="history.back()">‚¨Ö Return</button>
      <h1>Settings</h1>
      <p>Settings options coming soon...</p>
    </div>

  </div>

<script>
  function showSection(id) {
    document.querySelectorAll(".section").forEach(sec => sec.style.display = "none");
    document.getElementById(id).style.display = "block";
    document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("active"));
    event.target.classList.add("active");
    if (id === "requests") loadRequests();
  }

  async function loadRequests() {
    const token = localStorage.getItem('token');
    const res = await fetch('/api/requests/all', { headers: { 'Authorization': `Bearer ${token}` } });
    const tbody = document.querySelector('#requestTable tbody');

    if (!res.ok) {
      tbody.innerHTML = `<tr><td colspan="7">Access denied</td></tr>`;
      return;
    }

    const data = await res.json();
    tbody.innerHTML = "";
    data.forEach(req => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${req.user?.name ?? "Unknown"}</td>
        <td>${req.user?.email ?? "Unknown"}</td>
        <td>${req.documentType}</td>
        <td>${req.purpose}</td>
        <td>${req.status}</td>
        <td>${new Date(req.createdAt).toLocaleDateString()}</td>
        <td>
          <select onchange="updateStatus('${req._id}', this.value)">
            <option value="">Change Status</option>
            <option value="Approved">Approve</option>
            <option value="Processing">Processing</option>
            <option value="Released">Release</option>
            <option value="Rejected">Reject</option>
          </select>
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  async function updateStatus(id, status) {
    const token = localStorage.getItem('token');
    await fetch(`/api/requests/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({ status })
    });
    loadRequests();
  }

  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('token');
    window.location.href = '/login.html';
  });

  loadRequests();
</script>

</body>
</html>
